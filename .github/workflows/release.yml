name: adapter-release

on:
  push:
    tags:
      - "adapter-v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to release (e.g. adapter-v0.1.2)"
        required: true

permissions:
  contents: write

env:
  BINARY_NAME: vulnera-adapter
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # ---------------------------------------------------------------------------
  # Validate: test, lint, and confirm the Cargo.toml version matches the tag.
  # ---------------------------------------------------------------------------
  validate:
    name: Validate & Test
    runs-on: ubuntu-latest

    outputs:
      version: ${{ steps.extract_version.outputs.version }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust (stable)
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: . -> target

      - name: Extract version from Cargo.toml
        id: extract_version
        shell: bash
        run: |
          VERSION=$(cargo metadata --no-deps --format-version 1 \
            | python3 -c "import sys, json; print(json.load(sys.stdin)['packages'][0]['version'])")
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "Cargo.toml version: ${VERSION}"

      - name: Validate tag matches Cargo.toml version
        if: github.event_name == 'push'
        shell: bash
        run: |
          TAG_VERSION="${GITHUB_REF_NAME#adapter-v}"
          CARGO_VERSION="${{ steps.extract_version.outputs.version }}"
          if [ "${TAG_VERSION}" != "${CARGO_VERSION}" ]; then
            echo "::error::Tag version '${TAG_VERSION}' does not match Cargo.toml version '${CARGO_VERSION}'"
            exit 1
          fi
          echo "Version check passed: ${CARGO_VERSION}"

      - name: cargo test
        run: cargo test --locked

      - name: cargo clippy
        run: cargo clippy --locked -- -D warnings

  # ---------------------------------------------------------------------------
  # Build a native binary for each target triple.
  # ---------------------------------------------------------------------------
  build:
    name: Build · ${{ matrix.target }}
    needs: validate
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        include:
          # ── Linux ────────────────────────────────────────────────────────
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
            cross: false

          - target: aarch64-unknown-linux-gnu
            os: ubuntu-latest
            cross: true

          # ── macOS ────────────────────────────────────────────────────────
          - target: x86_64-apple-darwin
            os: macos-15-intel  # Intel runner
            cross: false

          - target: aarch64-apple-darwin
            os: macos-latest    # Apple Silicon runner
            cross: false

          # ── Windows ──────────────────────────────────────────────────────
          - target: x86_64-pc-windows-msvc
            os: windows-latest
            cross: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust (stable + target)
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: . -> target
          key: ${{ matrix.target }}

      # cross handles sysroot + linker setup for foreign Linux targets
      - name: Install cross (aarch64-linux only)
        if: matrix.cross
        uses: taiki-e/install-action@v2
        with:
          tool: cross

      - name: Build (native)
        if: "!matrix.cross"
        run: cargo build --release --locked --target ${{ matrix.target }}

      - name: Build (cross)
        if: matrix.cross
        run: cross build --release --locked --target ${{ matrix.target }}

      # ── Collect binary + checksum into dist/ ──────────────────────────────

      - name: Prepare artifact (Unix)
        if: matrix.os != 'windows-latest'
        shell: bash
        run: |
          mkdir -p dist
          BINARY="target/${{ matrix.target }}/release/${BINARY_NAME}"
          ARTIFACT_NAME="${BINARY_NAME}-${{ matrix.target }}"
          cp "$BINARY" "dist/${ARTIFACT_NAME}"
          cd dist
          sha256sum "${ARTIFACT_NAME}" > "${ARTIFACT_NAME}.sha256"

      - name: Prepare artifact (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path dist | Out-Null
          $binary   = "target\${{ matrix.target }}\release\${env:BINARY_NAME}.exe"
          $artifact = "${env:BINARY_NAME}-${{ matrix.target }}.exe"
          Copy-Item $binary "dist\$artifact"
          Set-Location dist
          $hash = (Get-FileHash $artifact -Algorithm SHA256).Hash.ToLower()
          "$hash  $artifact" | Out-File -Encoding ascii "${artifact}.sha256"

      - name: Upload artifact (Unix)
        if: matrix.os != 'windows-latest'
        uses: actions/upload-artifact@v4
        with:
          name: bin-${{ matrix.target }}
          path: |
            dist/${{ env.BINARY_NAME }}-${{ matrix.target }}
            dist/${{ env.BINARY_NAME }}-${{ matrix.target }}.sha256
          if-no-files-found: error

      - name: Upload artifact (Windows)
        if: matrix.os == 'windows-latest'
        uses: actions/upload-artifact@v4
        with:
          name: bin-${{ matrix.target }}
          path: |
            dist/${{ env.BINARY_NAME }}-${{ matrix.target }}.exe
            dist/${{ env.BINARY_NAME }}-${{ matrix.target }}.exe.sha256
          if-no-files-found: error

  # ---------------------------------------------------------------------------
  # Package the Rust crate source archive (for archive purposes).
  # ---------------------------------------------------------------------------
  package-crate:
    name: Package crate
    needs: validate
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust (stable)
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: . -> target

      - name: cargo package
        run: cargo package --locked

      - name: Checksum crate
        shell: bash
        run: |
          cd target/package
          sha256sum *.crate > SHA256SUMS.txt

      - name: Upload crate artifact
        uses: actions/upload-artifact@v4
        with:
          name: crate-package
          path: |
            target/package/*.crate
            target/package/SHA256SUMS.txt
          if-no-files-found: error

  # ---------------------------------------------------------------------------
  # Combine all artifacts into a single GitHub Release.
  # ---------------------------------------------------------------------------
  publish-release:
    name: Publish GitHub Release
    needs: [validate, build, package-crate]
    runs-on: ubuntu-latest

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release
          merge-multiple: true

      - name: List release contents
        run: ls -lh release/

      - name: Combine checksums
        run: |
          cd release
          # Merge all per-binary .sha256 files and the crate SHA256SUMS.txt
          find . -name "*.sha256" -o -name "SHA256SUMS.txt" \
            | xargs cat 2>/dev/null \
            | sort -u > ALL_SHA256SUMS.txt
          rm -f SHA256SUMS.txt
          cat ALL_SHA256SUMS.txt

      - name: Determine release tag
        id: release_tag
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "tag=${{ inputs.tag }}" >> "$GITHUB_OUTPUT"
          else
            echo "tag=${{ github.ref_name }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.release_tag.outputs.tag }}
          name: ${{ steps.release_tag.outputs.tag }}
          body: |
            ## vulnera-adapter v${{ needs.validate.outputs.version }}

            ### Platform binaries
            Download the binary for your platform below.

            | Platform | Asset |
            |---|---|
            | Linux x86_64 | `vulnera-adapter-x86_64-unknown-linux-gnu` |
            | Linux ARM64 | `vulnera-adapter-aarch64-unknown-linux-gnu` |
            | macOS Intel | `vulnera-adapter-x86_64-apple-darwin` |
            | macOS Apple Silicon | `vulnera-adapter-aarch64-apple-darwin` |
            | Windows x86_64 | `vulnera-adapter-x86_64-pc-windows-msvc.exe` |

            Checksums are in `ALL_SHA256SUMS.txt`.
          files: |
            release/${{ env.BINARY_NAME }}-x86_64-unknown-linux-gnu
            release/${{ env.BINARY_NAME }}-x86_64-unknown-linux-gnu.sha256
            release/${{ env.BINARY_NAME }}-aarch64-unknown-linux-gnu
            release/${{ env.BINARY_NAME }}-aarch64-unknown-linux-gnu.sha256
            release/${{ env.BINARY_NAME }}-x86_64-apple-darwin
            release/${{ env.BINARY_NAME }}-x86_64-apple-darwin.sha256
            release/${{ env.BINARY_NAME }}-aarch64-apple-darwin
            release/${{ env.BINARY_NAME }}-aarch64-apple-darwin.sha256
            release/${{ env.BINARY_NAME }}-x86_64-pc-windows-msvc.exe
            release/${{ env.BINARY_NAME }}-x86_64-pc-windows-msvc.exe.sha256
            release/ALL_SHA256SUMS.txt
            release/*.crate
          generate_release_notes: false
          draft: false
          prerelease: ${{ contains(steps.release_tag.outputs.tag, '-alpha') || contains(steps.release_tag.outputs.tag, '-beta') || contains(steps.release_tag.outputs.tag, '-rc') }}
          fail_on_unmatched_files: true
